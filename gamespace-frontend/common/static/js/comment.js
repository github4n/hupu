/**
 * @Description: common
 * @author: wangjun
 * @Update: 2014-05-27 17:05 
 */

(function(t){if(window.comment!==void 0)return!1;var e=window,a=document,i={init:function(){if(this.place=hp.$("#hp-comment-showItem"),!this.place)return!1;var t=hp.attr(this.place,"data-appid"),e=hp.attr(this.place,"data-topicid"),i=hp.attr(this.place,"data-title")||a.title,s=hp.attr(this.place,"data-link")||location.href;i=i.replace(/\(/g,"\uff08"),i=i.replace(/\)/g,"\uff09"),hp.loadStyle("http://b3.hoopchina.com.cn/web/module/comment/1.0.1/css/comment.min.css"),this.domain="http://comment.hupu.com/interface/comment/",this.avatarUrl="http://bbs.hupu.com/bbskcy/api_new_image.php?uid=",this.myUrl="http://my.hupu.com/",this.topicId="?appid="+t+"&topic_id="+e,this.commentUrl=this.domain+"showlist"+this.topicId,this.highlightsUrl=this.domain+"light/?callback=?",this.replyUrl=this.domain+"create/?callback=?",this.reportUrl=this.domain+"report/?callback=?",this.highlightsPostData=this.reportPostData={appid:t,topic_id:e},this.replyPostData={appid:t,topic_id:e,title:i,link:s},this.posNewsLocate(),this.initEvent()},initEvent:function(){var t,e,a,i=this,s=RegExp("(^|\\s)hp-comm-paging(\\s|$)"),o=RegExp("(^|\\s)btn-highlights(\\s|$)"),p=RegExp("(^|\\s)btn-report(\\s|$)"),r=RegExp("(^|\\s)btn-at(\\s|$)");hp.bind(this.place,"click",function(h){if(h=hp.event(h),h.stopPropagation(),t=h.target,"A"==t.tagName.toLocaleUpperCase()||"I"==t.tagName.toLocaleUpperCase()){if(e=t.className,a=t.parentElement.className,r.test(e)&&(h.preventDefault(),i.at(t)),p.test(e)&&i.popReport(t),o.test(e)||o.test(a)){if(o.test(e))return i.getHighlights(t),!1;i.getHighlights(t.parentElement)}/btn-reply/.test(e)&&(h.preventDefault(),i.textareaBox.focus()),s.test(a)&&(h.preventDefault(),i.loadComment(t.href))}return!1})},posNewsLocate:function(){var t=location.hash,e=RegExp("#comment-");if(!e.test(t))return this.loadComment(this.commentUrl,!0),!1;var a=t.split("-");this.loadComment(this.commentUrl+"&page="+a[1],!0,function(){var t=hp.$(".hp-comm-item-dl",this.place);hp.each(t,function(){hp.attr(this,"data-comment-id")==a[2]&&window.scrollTo(0,parseInt(hp.getOffsetPos(this).top))})})},loadComment:function(t,e,a){var i=this,s="",a=a||function(){};t+="&callback=?",e?(s+='<div class="hp-comment-A">',s+=i.loading()):this.allItemBox.innerHTML=i.loading(),hp.getJSON(t,function(t){return 200==t.code?(i.userData={status:t.users?!0:!1,uid:t.users.uid?t.users.uid:"",name:t.users.username?t.users.username:"",lou:t.lou,page:t.page,redirect_page:t.redirect_page,total_page:t.total_page,min:t.number_limit.min,max:t.number_limit.max},e&&t.lights_data&&(s+='<div class="hp-comm-highlights"><div class="highlights-hd"><h2>\u8fd9\u4e9b\u8bc4\u8bba\u4eae\u4e86</h2></div>',s+=i.commentItem(t.lights_data,!0),s+="</div>"),t.data.comments?(e&&(s+='<div class="hp-comm-hd"><div class="hdInfo"><h3>\u5df2\u6709<span class="hp-comm-totalPage">'+t.total_page+'</span>\u6761\u8bc4\u8bba</h3><a class="btn-reply" href="#hp-comm-anchor-reply"><i class="ico-reply"></i>\u6211\u8981\u8bc4\u8bba</a></div></div>',s+='<div class="hp-comm-allItem">'),s+=i.commentItem(t.data.comments),t.paging&&(s+=t.paging),e&&(s+="</div>")):s+='<div class="hp-comm-firstPlace">\u60a8\u662f\u7b2c\u4e00\u4e2a\u5230\u8fbe\u8fd9\u91cc\u7684\uff0c\u5feb\u6765\u53d1\u8868\u770b\u6cd5</div>',e?(s+=i.replyTextarea(),s+="</div>",i.place.innerHTML=s,i.loadingBox=hp.$(".hp-comm-loading",i.place)[0],i.allItemBox=hp.$(".hp-comm-allItem",i.place)[0],i.totalPage=hp.$(".hp-comm-totalPage",i.place)[0],i.textareaBox=hp.$(".textareaValue",i.place)[0],hp.hide(i.loadingBox),i.replyComment()):(i.totalPage.innerHTML=t.total_page,i.allItemBox.innerHTML=s),a(),!1):void 0})},loading:function(){var t='<div class="hp-comm-loading"><i class="ico-loading"></i>\u6b63\u5728\u52a0\u8f7d...</div>';return t},commentItem:function(t,e){var a,i,s=this,o='<div class="hp-comm-item-A">';return hp.each(t,function(t){a=s.userData.lou+t+1,o+='<dl class="hp-comm-item-dl" data-comment-id='+this.comment_id+">",o+='<dt class="userAvatar"><a href="'+s.myUrl+this.uid+'" target="_blank"><img src="'+s.avatarUrl+this.uid+'"></a></dt>',o+='<dd class="userInfo-hd">',o+='<a href="'+s.myUrl+this.uid+'" class="userName" target="_blank">'+this.username+"</a>",o+='<span class="releaseTime">'+this.publish_time+"</span>",o+='<span class="comm-highlights-box"><a class="btn-highlights" href="javascript:void(0)" title="\u4eae\u4e86" data-comment-id="'+this.comment_id+'"><i class="voice-ico-brigth"></i>\u4eae\u4e86</a><span class="highlights-num">('+this.light_num+")</span></span>",i=0==this.root_id?this.comment_id:this.root_id,o+='<span class="hd-right"><a class="btn-report" href="javascript:void(0);" data-user-name="'+this.username+'" data-comment-id="'+this.comment_id+'">\u4e3e\u62a5</a><a href="#hp-comm-anchor-reply" class="btn-at" data-at="'+this.username+'" data-root-id='+i+" data-parent-id="+this.comment_id+">\u8bc4\u8bba",e?"":o+="&nbsp;"+a+"\u697c",o+="</a></span></dd>",o+='<dd class="comm-bd">'+this.contents+"</dd>",o+="</dl>"}),o+="</div>"},replyTextarea:function(){var t='<div id="hp-comm-anchor-reply" class="hp-comm-replyBox">',e="http://i1.hoopchina.com.cn/user/default_small.jpg",a="http://my.hupu.com/me";return this.userData.status&&(e=this.avatarUrl+this.userData.uid,a=this.myUrl+this.userData.uid),t+='<div class="userAvatar"><a href="'+a+'" target="_blank"><img src="'+e+'"></a></div>',t+='<div class="reply-bd">',t+='<div class="textarea-box"><textarea name="content" class="textareaValue">\u8bf7\u8f93\u5165\u8bc4\u8bba\u5185\u5bb9</textarea>',t+=this.userData.status?'<div class="hp-comm-tip-success"><i></i>\u8bc4\u8bba\u6210\u529f\uff01</div>':'<div class="hp-comm-notLogin">\u60a8\u5c1a\u672a\u767b\u5f55\uff0c\u8bf7\u5148 <a href="http://passport.hupu.com/login" onclick="commonLogin(); return false;">\u767b\u5f55</a> \u6216\u8005 <a href="http://passport.hupu.com/register">\u6ce8\u518c</a></div>',t+="</div>",t+='<p class="bot"><input type="submit" class="btn-postReply" value="\u8bc4\u8bba" /></p>',t+="</div></div>"},notLogin:function(){return this.userData.status||commonLogin(),!1},replyComment:function(){var t=this;parseInt(hp.getStyle(this.textareaBox).width)||550,this.btnReply=hp.$(".btn-postReply",this.place)[0],this.tipSuccess=hp.$(".hp-comm-tip-success",this.place)[0],this.textareaDefaultValue=this.textareaBox.defaultValue,hp.bind(this.textareaBox,"focus",function(){t.textareaBox.value==t.textareaDefaultValue&&(t.textareaBox.value=""),hp.css(t.textareaBox,{color:"#444"})}),hp.bind(this.textareaBox,"blur",function(){""==hp.trim(t.textareaBox.value)&&(t.textareaBox.value=t.textareaDefaultValue),hp.css(t.textareaBox,{color:"#999"})}),hp.bind(this.textareaBox,"keyup",function(){t.autoTextarea(this)}),hp.bind(this.textareaBox,"keydown",function(a){a=a||e.event,13==a.keyCode&&a.ctrlKey&&t.replayData()}),hp.bind(this.btnReply,"click",function(){t.replayData()})},autoTextarea:function(t){var e=parseInt(hp.getStyle(t).height)||60,a=t.scrollHeight;a>e&&hp.css(t,{overflowY:"hidden",h:a})},replayData:function(){var t=this,e=hp.trim(this.textareaBox.value),a=e.length;switch(this.replyPostData.uid=this.userData.uid,this.replyPostData.contents=e,/^\u56de\u590d@[\.\w+]+:/.test(e)||(this.replyPostData.root_id="",this.replyPostData.parent_id=""),!0){case!this.userData.status:this.notLogin();break;case this.userData.min>a||a>this.userData.max:this.tipWarning(-4,2);break;case e==this.textareaDefaultValue:this.textareaBox.value="",this.textareaBox.focus();break;default:hp.getJSON(this.replyUrl,this.replyPostData,function(e){switch(e.code){case 200:t.replaySuccessData();break;default:t.tipWarning(e.code,2)}})}},replaySuccessData:function(){var t,e=this,a=this.commentUrl+"&page=";this.textareaBox.value="",hp.css(this.textareaBox,{h:"60"}),hp.show(this.tipSuccess),this.btnReply.disabled=!0,a+=0!=this.userData.redirect_page&&0==this.userData.total_page%this.userData.page?this.userData.redirect_page+1:this.userData.redirect_page,0==this.userData.redirect_page?this.loadComment(a,!0):this.loadComment(a),t=setTimeout(function(){clearTimeout(t),hp.hide(e.tipSuccess),e.btnReply.disabled=!1},2e3)},getHighlights:function(t){if(!this.userData.status)return this.notLogin(),!1;var e=this,a=hp.$(".btn-highlights",this.place),i=t.getAttribute("data-comment-id");this.highlightsPostData.comment_id=i,hp.getJSON(this.highlightsUrl,this.highlightsPostData,function(t){switch(t.code){case 200:hp.each(a,function(){hp.attr(this,"data-comment-id")==i&&(hp.next(this).innerHTML="("+t.data.light+")")});break;default:e.tipWarning(t.code,1)}})},at:function(t){if(!this.userData.status)return this.notLogin(),!1;this.textareaBox.focus();var e=this.textareaBox.value,a=/^\u56de\u590d@[\.\w\u4e00-\u9fa5+]+:/;this.replyPostData.root_id=parseInt(t.getAttribute("data-root-id")),this.replyPostData.parent_id=parseInt(t.getAttribute("data-parent-id")),this.textareaBox.value=a.test(e)?e.replace(a,"\u56de\u590d@"+t.getAttribute("data-at")+":"):"\u56de\u590d@"+t.getAttribute("data-at")+": "+e},popReport:function(t){if(!this.userData.status)return this.notLogin(),!1;var e=this,i=hp.getView(),s=(i.height-300)/2,o=(i.width-400)/2,p=t.getAttribute("data-user-name");if(this.reportCommentId=t.getAttribute("data-comment-id"),hp.browser.msie&&"6.0"==hp.browser.version&&(s+=i.scrollTop,o+=i.scrollLeft),_common.popMask(),this.popReportStatus)hp.each(this.reportTypeValue,function(){this.checked&&(this.checked=!1)}),this.reportNameBox.innerHTML=p;else{this.popReportStatus=!0,hp.append(a.body,'<div id="hp-comm-popReport" class="hp-comm-popReport"><div class="hd"><h2>\u4e3e\u62a5</h2><a href="javascript:void(0)" title="\u5173\u95ed" class="close">X</a></div><div class="bd"><dl class="reportItem"><dt>\u4e3e\u62a5 <span class="hp-comm-popReport-username">'+p+'</span> \u53d1\u8868\uff1a</dt><dd><label><input type="radio" value="1" name="reportTypeName" class="report-type-name" />\u5e7f\u544a</label></dd><dd><label><input type="radio" value="2" name="reportTypeName" class="report-type-name" />\u8272\u60c5</label></dd><dd><label><input type="radio" value="3" name="reportTypeName" class="report-type-name" />\u53cd\u52a8</label></dd><dd><label><input type="radio" value="4" name="reportTypeName" class="report-type-name" />\u4eba\u8eab\u653b\u51fb</label></dd><dd><label><input type="radio" value="5" name="reportTypeName" class="report-type-name" />\u5176\u4ed6</label></dd></dl><div class="btn"><input type="button" class="hp-btn-A" value="\u786e\u5b9a" /><input type="button" class="hp-btn-B" value="\u53d6\u6d88" /></div></div></div>'),this.maskReport=hp.$(".hp-mask")[0],this.reportObj=hp.$("#hp-comm-popReport"),this.reportNameBox=hp.$(".hp-comm-popReport-username",this.reportObj)[0],this.reportTypeValue=hp.$(".report-type-name",this.reportObj);var r=hp.$(".close",this.reportObj)[0],h=hp.$(".hp-btn-B",this.reportObj)[0];this.btnReportTipYes=hp.$(".hp-btn-A",this.reportObj)[0],hp.bind(r,"click",function(){e.closeReportTip()}),hp.bind(this.btnReportTipYes,"click",function(){e.getReport()}),hp.bind(h,"click",function(){e.closeReportTip()})}hp.css(this.reportObj,{d:"block",t:s,l:o})},closeReportTip:function(){hp.hide(this.reportObj),hp.hide(this.maskReport)},getReport:function(){var t,e=this;return hp.each(this.reportTypeValue,function(){this.checked&&(t=this.value)}),t?(this.reportPostData.comment_id=this.reportCommentId,this.reportPostData.type=t,hp.getJSON(this.reportUrl,this.reportPostData,function(t){e.tipWarning(t.code,3)}),e.closeReportTip(),void 0):!1},tipWarning:function(t,e){var i=this,s=hp.getView(),o=s.scrollTop+(s.height-350)/2,p=s.scrollLeft+(s.width-350)/2;if(e&&(t=this.getWarningArray(e)[t]),!t)return!1;this.tipWarningStatus?this.tipErrorValue.innerHTML=t:(this.tipWarningStatus=!0,hp.append(a.body,'<div id="hp-comm-popTip" class="hp-comm-popTip"><i class="hp-comm-popTip-ico"></i><span id="hp-comm-tip-errorValue">'+t+"</span></div>"),this.popTip=hp.$("#hp-comm-popTip"),this.tipErrorValue=hp.$("#hp-comm-tip-errorValue")),hp.css(this.popTip,{d:"block",t:o,l:p});var r=setTimeout(function(){clearTimeout(r),hp.hide(i.popTip)},2130)},getWarningArray:function(t){var e=e||[];switch(t){case 1:e={0:"\u5931\u8d25",11:"\u56de\u590d\u4e0d\u5b58\u5728\u6216\u5df2\u88ab\u5220\u9664","-1":"\u51fa\u9519\u5566","-2":"\u8bf7\u9009\u767b\u5f55","-3":"\u7528\u6237\u4fe1\u606f\u83b7\u53d6\u5931\u8d25\uff0c\u8bf7\u91cd\u65b0\u5237\u65b0\u9875\u9762","-5":"\u8be5\u6761\u8bc4\u8bba\u5df2\u88ab\u5220\u9664","-6":"\u4e0d\u80fd\u70b9\u4eae\u81ea\u5df1\u53d1\u8868\u7684\u8bc4\u8bba","-7":"\u4f60\u5df2\u70b9\u4eae\u8fc7\u8be5\u8bc4\u8bba\uff0c\u4e0d\u53ef\u518d\u70b9\u4eae","-10":"\u4f60\u5df2\u88ab\u7981\u8a00\uff0c\u8bf7\u7b49\u5f85\u89e3\u7981","-11":"IP\u5df2\u88ab\u5c01\u7981","-12":"ID\u88ab\u6c38\u4e45\u5c01\u7981"};break;case 2:e={0:"\u5931\u8d25","-1":"\u51fa\u9519\u5566","-2":"\u8bf7\u9009\u767b\u5f55","-3":"\u7528\u6237\u4fe1\u606f\u83b7\u53d6\u5931\u8d25\uff0c\u8bf7\u91cd\u65b0\u5237\u65b0\u9875\u9762","-4":"\u5185\u5bb9\u592a\u5c11\u6216\u592a\u591a\u4e86\uff0c\u8bf7\u63a7\u5236\u5728"+this.userData.min+"-"+this.userData.max+"\u5b57\u4e4b\u95f4","-8":"\u8be5\u8bc4\u8bba\u5df2\u53d1\u8868\uff0c\u8bf7\u52ff\u91cd\u590d\u53d1\u8868","-9":"\u4f60\u8bc4\u8bba\u7684\u592a\u9891\u7e41\u4e86\uff0c\u8bf7\u7a0d\u540e\u518d\u53d1\u8868","-10":"\u4f60\u5df2\u88ab\u7981\u8a00\uff0c\u8bf7\u7b49\u5f85\u89e3\u7981","-11":"IP\u5df2\u88ab\u5c01\u7981","-12":"ID\u88ab\u6c38\u4e45\u5c01\u7981","-13":"\u4f60@\u4e86\u592a\u591a\u4eba\u4e86\uff0c\u6700\u591a10\u4e2a","-15":"\u8bc4\u8bba\u542b\u5e7f\u544a\u6216\u5783\u573e\u4fe1\u606f\uff0c\u8bf7\u6ce8\u610f\u8a00\u884c\uff01"};break;case 3:e={0:"\u5931\u8d25",200:"\u4f60\u5df2\u4e3e\u62a5\u6210\u529f\uff0c\u6211\u4eec\u4f1a\u5c3d\u5feb\u5904\u7406","-1":"\u51fa\u9519\u5566","-2":"\u8bf7\u9009\u767b\u5f55","-3":"\u7528\u6237\u4fe1\u606f\u83b7\u53d6\u5931\u8d25\uff0c\u8bf7\u91cd\u65b0\u5237\u65b0\u9875\u9762","-4":"\u4f60\u5df2\u4e3e\u62a5\u8fc7\u8be5\u6761\u8bc4\u8bba\uff0c\u4e0d\u53ef\u91cd\u590d\u4e3e\u62a5","-5":"\u8be5\u6761\u8bc4\u8bba\u5df2\u88ab\u5220\u9664","-10":"\u4f60\u5df2\u88ab\u7981\u8a00\uff0c\u8bf7\u7b49\u5f85\u89e3\u7981","-11":"IP\u5df2\u88ab\u5c01\u7981","-12":"ID\u88ab\u6c38\u4e45\u5c01\u7981"}}return e}};hp.ready(function(){i.init()}),t.comment=i})(window);
